<html>
<head>
<title>Broadcast</title>
</head>
<body>
<video autoplay="true" id="client">
<canvas id="canvasOne" width="500" height="300"></canvas></video>
<canvas id="canvasTwo" width="500" height="300"></canvas>
<script>

var socket = new WebSocket("ws://localhost:8000");
var theCanvas = document.getElementById("canvasOne");
var context = theCanvas.getContext("2d");
var theCanvas2 = document.getElementById("canvasTwo");
var context2 = theCanvas2.getContext("2d");
var video = document.getElementById('client');
var streamdata;
var imagedata;
navigator.webkitGetUserMedia('video', function(stream) { video.src=webkitURL.createObjectURL(stream); }, function(error) { log('Capture error ' + error); });

function draw(v, ctx, w, h) {
  context.drawImage(v, 0, 0, w, h)
  getArray();
  setTimeout(function() { draw(v, ctx, w, h); }, 33);
}
function getArray(){
  imagedata = context.getImageData(0, 0, theCanvas.width,theCanvas.height);
  var canvaspixelarray = imagedata.data;
 
  var canvaspixellen = canvaspixelarray.length;
  bytearray = new Uint8Array(canvaspixellen);
 
  for (var i=0;i<canvaspixellen;++i) {
    bytearray[i] = canvaspixelarray[i];
  }
  socket.send(bytearray, {binary: true, mask: true});
}




socket.onmessage = function(event) {
  // Normally you'd expect that event.data is a string, but in
  // binary transfer u get a write-protected Blob of data
  // which can be read as a stream.

  var reader = new FileReader();

  // There is also readAsBinaryString method if you are not using typed arrays
  reader.readAsArrayBuffer(event.data);
  reader.onloadend = function() {
    var bytearray = new Uint8Array(this.result);
    console.log(bytearray);
    imageheight = theCanvas2.height;
    imagewidth = theCanvas2.width;
    var imgdata = context2.getImageData(0,0,imagewidth,imageheight);
    var imgdatalen = imgdata.data.length;
    for(var i=8;i<imgdatalen;i++)
    {
      imgdata.data[i] = bytearray[i];
    }
    context2.putImageData(imgdata,0,0);
  }
};
draw(video, context, theCanvas.width, theCanvas.height);x
</script>
